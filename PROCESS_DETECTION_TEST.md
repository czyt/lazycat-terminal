# VTE 进程检测功能测试说明

## 功能概述
在关闭 VTE 终端控件前，系统会自动检测是否有正在运行的进程（非 shell 进程）。如果检测到活跃进程，会弹出确认对话框，只有用户确认后才会杀掉进程并关闭 VTE。

## 实现的三个检测场景

### 1. Ctrl + Shift + Q - 关闭当前 VTE
- 快捷键：`Ctrl + Shift + Q`
- 检测：仅检测当前聚焦的 VTE 是否有活跃进程
- 行为：
  - 如果有活跃进程：弹出确认对话框，用户确认后杀掉进程并关闭 VTE
  - 如果没有活跃进程：直接关闭 VTE

### 2. Ctrl + Alt + Q - 关闭其他所有 VTE
- 快捷键：`Ctrl + Alt + Q`
- 检测：检测当前标签页中除当前 VTE 外的所有其他 VTE 是否有活跃进程
- 行为：
  - 如果有任何一个 VTE 有活跃进程：弹出确认对话框，用户确认后杀掉所有进程并关闭所有其他 VTE
  - 如果都没有活跃进程：直接关闭所有其他 VTE

### 3. Ctrl + Shift + W - 关闭当前标签页
- 快捷键：`Ctrl + Shift + W`
- 检测：检测当前标签页中所有 VTE 是否有活跃进程
- 行为：
  - 如果有任何一个 VTE 有活跃进程：弹出确认对话框，用户确认后杀掉所有进程并关闭标签页
  - 如果都没有活跃进程：直接关闭标签页

### 4. 关闭窗口
- 操作：点击窗口关闭按钮或快捷键
- 检测：检测所有标签页中所有 VTE 是否有活跃进程
- 行为：
  - 如果有任何一个 VTE 有活跃进程：弹出确认对话框，用户确认后关闭窗口
  - 如果都没有活跃进程：直接关闭窗口

## 确认对话框样式

- **无边框窗口**：对话框本身没有系统默认边框
- **对话框边框**：使用 VTE 前景色的 1px 实线边框（默认绿色 #00cd00）
- **透明背景**：背景颜色为黑色，透明度 0.95（比主窗口更深）
- **投影**：使用与主窗口相同的投影效果（`box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.35)`）
- **圆角**：8px 圆角
- **右上角关闭按钮**：
  - 使用 Cairo 绘制 X 形状
  - 颜色使用 VTE 前景色（默认绿色 #00cd00）
  - 默认状态：alpha = 0.6（半透明）
  - 悬停状态：alpha = 0.85（更亮）
  - 按下状态：alpha = 1.0（完全不透明）
  - 点击或按 Esc 键可关闭对话框（不执行关闭 VTE 操作）
- **警告文本**：
  - 颜色与当前 VTE 前景色一致（默认为绿色 #00cd00）
  - 文字居中显示
- **确认按钮**：
  - 文案："确认结束"
  - 文字颜色与 VTE 前景色一致
  - 边框使用 VTE 前景色的 1px 实线
  - **默认状态**：完全透明背景，只显示边框（覆盖 GTK 默认的 focus 蓝色边框）
  - **Focus 状态**：保持透明背景和前景色边框（移除 GTK 默认样式）
  - **悬停状态**：背景色为前景色的半透明（透明度 0.2）
  - **按下状态**：背景色为前景色的半透明（透明度 0.3）
  - **对话框打开时自动聚焦到此按钮**
  - **可以直接按回车键确认操作**

## 测试步骤

1. **启动程序**
   ```bash
   ./build/lazycat-terminal
   ```

2. **测试场景 1：关闭有活跃进程的 VTE**
   - 在终端中运行一个长时间进程，例如：`top` 或 `htop`
   - 按 `Ctrl + Shift + Q`
   - 应该弹出确认对话框，焦点自动在"确认结束"按钮上
   - **方式1**：直接按 `Enter` 键确认，VTE 应该关闭
   - **方式2**：点击"确认结束"按钮，VTE 应该关闭
   - **方式3**：按 `Esc` 键或点击右上角关闭按钮，对话框关闭但 VTE 不关闭

3. **测试场景 2：关闭没有活跃进程的 VTE**
   - 在终端中不运行任何程序（只有 shell）
   - 按 `Ctrl + Shift + Q`
   - VTE 应该直接关闭，不弹出对话框

4. **测试场景 3：关闭其他 VTE**
   - 使用 `Ctrl + Shift + J` 或 `Ctrl + Shift + H` 创建多个分屏
   - 在某个非当前 VTE 中运行 `top`
   - 切换回另一个 VTE
   - 按 `Ctrl + Alt + Q`
   - 应该弹出确认对话框
   - 确认后，其他所有 VTE 都应该关闭

5. **测试场景 4：关闭标签页**
   - 在当前标签页的某个 VTE 中运行 `top`
   - 按 `Ctrl + Shift + W`
   - 应该弹出确认对话框
   - 确认后，整个标签页应该关闭

6. **测试场景 5：关闭窗口**
   - 在某个 VTE 中运行 `top`
   - 点击窗口关闭按钮
   - 应该弹出确认对话框
   - 确认后，窗口应该关闭

## 进程检测原理

程序通过以下方式检测 VTE 中是否有活跃进程：

1. 获取 VTE 的 PTY（伪终端）文件描述符
2. 使用 `tcgetpgrp()` 获取前台进程组 ID
3. 将前台进程组 ID 与 shell 的进程 ID 比较
4. 如果不同且大于 0，说明有活跃进程在运行

杀死进程使用 `SIGKILL` 信号（强制终止）。

## 已知限制

- 当前实现使用 `SIGKILL` 强制终止进程，不给进程清理的机会
- 后台进程不会被检测（只检测前台进程组）
